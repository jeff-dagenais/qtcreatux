#!/bin/bash

kconfig2qmk

PRO=$(basename $(pwd)).pro

SRC_DIR=$(readlink source)

if [ -z "$SRC_DIR" ]
then
	echo "This Makefile is meant to be invoked in a pre-prepared kernel build tree, run \"make prepare modules-prepare\" in this directory first." >&2
	exit 1
fi

SRC_DIRS=" \
arch \
drivers \
$SRC_DIR/arch/arm \
$SRC_DIR/arch/x86 \
$SRC_DIR/arch/tile \
$SRC_DIR/drivers/acpi \
$SRC_DIR/drivers/cpufreq \
$SRC_DIR/drivers/base \
$SRC_DIR/drivers/char \
$SRC_DIR/drivers/clk \
$SRC_DIR/drivers/mfd \
$SRC_DIR/drivers/uio \
$SRC_DIR/drivers/leds \
$SRC_DIR/drivers/platform \
$SRC_DIR/drivers/dma \
$SRC_DIR/drivers/gpu/drm \
$SRC_DIR/drivers/base \
$SRC_DIR/drivers/pci \
$SRC_DIR/drivers/of \
$SRC_DIR/drivers/usb \
$SRC_DIR/drivers/gpio \
$SRC_DIR/drivers/i2c \
$SRC_DIR/drivers/w1 \
$SRC_DIR/drivers/gpu \
$SRC_DIR/drivers/input \
$SRC_DIR/drivers/spi \
$SRC_DIR/drivers/misc \
$SRC_DIR/drivers/net \
$SRC_DIR/drivers/parport \
$SRC_DIR/drivers/regulator \
$SRC_DIR/drivers/hwmon \
$SRC_DIR/drivers/firmware \
$SRC_DIR/drivers/iio \
$SRC_DIR/drivers/usb \
$SRC_DIR/drivers/hid \
$SRC_DIR/drivers/media \
$SRC_DIR/drivers/mtd \
$SRC_DIR/drivers/video/fbdev/xylon \
$SRC_DIR/kernel \
$SRC_DIR/fs \
$SRC_DIR/include \
$SRC_DIR/init \
$SRC_DIR/ipc \
$SRC_DIR/kernel \
$SRC_DIR/lib \
$SRC_DIR/mm \
$SRC_DIR/net \
"

OTHER_FILES="\
$SRC_DIR/arch/arm/boot \
"

echo "# This file was automatically generated by $0" > $PRO
echo -n "# " >> $PRO
date >> $PRO
echo >> $PRO
echo "include(autoconf.qmk)" >> $PRO
echo "INCLUDEPATH += include source/include" >> $PRO
echo "DEFINES += DEBUG __KERNEL__" >> $PRO
echo >> $PRO
echo "SOURCES += \\" >> $PRO
find $SRC_DIRS -type f -name "*.c" -not -name "*.mod.c" -printf "%p \\\\\\n" >> $PRO
echo >> $PRO
echo "HEADERS += \\" >> $PRO
find $SRC_DIRS -type f -name "*.h" -printf "%p \\\\\\n" >> $PRO
find include -type f -printf "%p \\\\\\n" >> $PRO
echo >> $PRO
echo "OTHER_FILES += $0 \\" >> $PRO
echo "autoconf.qmk \\" >> $PRO
find $SRC_DIR/Documentation -type f -printf "%p \\\\\\n" >> $PRO
find include -type f -not -name "*.h" -printf "%p \\\\\\n" >> $PRO
find $OTHER_FILES -type f -not -name "*.h" -printf "%p \\\\\\n" >> $PRO
find $SRC_DIR/ -name Makefile -printf "%p \\\\\\n" >> $PRO
find $SRC_DIR/ -name Kconfig -printf "%p \\\\\\n" >> $PRO

cat <<EOF >>$PRO
$SRC_DIR/README \\
$SRC_DIR/MAINTAINERS \\
.config \\
EOF

echo >> $PRO

echo -n "Done. "
wc -l $PRO

